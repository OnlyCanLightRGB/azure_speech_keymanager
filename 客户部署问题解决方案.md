# å®¢æˆ·æœåŠ¡å™¨éƒ¨ç½²é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸš¨ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šç½‘ç»œè¿æ¥é—®é¢˜ - Dockeré•œåƒä¸‹è½½å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
failed to solve: node:18-alpine: failed to resolve source metadata for docker.io/library/node:18-alpine: failed to do request: Head "https://mirror.ccs.tencentyun.com/v2/library/node/manifests/18-alpine?ns=docker.io": EOF
```

**åŸå› **ï¼š
- å®¢æˆ·æœåŠ¡å™¨ç½‘ç»œé™åˆ¶
- Dockeré•œåƒæºè®¿é—®é—®é¢˜
- é˜²ç«å¢™é˜»æ­¢Docker Hubè®¿é—®

**è§£å†³æ–¹æ¡ˆAï¼šä½¿ç”¨å›½å†…é•œåƒæº**
```bash
# 1. é…ç½®Dockeré•œåƒæº
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
EOF

# 2. é‡å¯DockeræœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart docker

# 3. é‡æ–°æ„å»º
docker-compose up --build -d
```

**è§£å†³æ–¹æ¡ˆBï¼šé¢„ä¸‹è½½é•œåƒ**
```bash
# æ‰‹åŠ¨ä¸‹è½½æ‰€éœ€é•œåƒ
docker pull node:18-alpine
docker pull mysql:5.7
docker pull redis:7-alpine

# ç„¶åæ„å»º
docker-compose up --build -d
```

**è§£å†³æ–¹æ¡ˆCï¼šç¦»çº¿éƒ¨ç½²åŒ…**
```bash
# åœ¨æœ‰ç½‘ç»œçš„ç¯å¢ƒä¸­å¯¼å‡ºé•œåƒ
docker save node:18-alpine mysql:5.7 redis:7-alpine > docker-images.tar

# åœ¨å®¢æˆ·æœåŠ¡å™¨ä¸Šå¯¼å…¥
docker load < docker-images.tar

# ç„¶åæ„å»º
docker-compose up --build -d
```

### é—®é¢˜2ï¼šç«¯å£å ç”¨é—®é¢˜

**ç—‡çŠ¶**ï¼š
```
bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000
lsof -i :3019

# 2. åœæ­¢å ç”¨è¿›ç¨‹
sudo kill -9 <PID>

# 3. æˆ–ä¿®æ”¹ç«¯å£é…ç½®
# ç¼–è¾‘ docker-compose.yml
ports:
  - "0.0.0.0:3001:3000"  # æ”¹ä¸º3001
  - "0.0.0.0:3020:3019"  # æ”¹ä¸º3020
```

### é—®é¢˜3ï¼šæƒé™é—®é¢˜

**ç—‡çŠ¶**ï¼š
```
permission denied
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ·»åŠ ç”¨æˆ·åˆ°dockerç»„
sudo usermod -aG docker $USER
newgrp docker

# 2. è®¾ç½®æ–‡ä»¶æƒé™
sudo chown -R $USER:$USER .
chmod +x *.sh

# 3. é‡æ–°ç™»å½•æˆ–é‡å¯
```

### é—®é¢˜4ï¼šå†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼š
- å®¹å™¨é¢‘ç¹é‡å¯
- æ„å»ºè¿‡ç¨‹ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h
docker system df

# 2. æ¸…ç†Dockerç¼“å­˜
docker system prune -a -f

# 3. å¢åŠ swapç©ºé—´
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

## ğŸ› ï¸ å®¢æˆ·æœåŠ¡å™¨å¿«é€Ÿéƒ¨ç½²è„šæœ¬

### ä¸€é”®éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# å®¢æˆ·æœåŠ¡å™¨ä¸€é”®éƒ¨ç½²è„šæœ¬

echo "ğŸš€ å¼€å§‹éƒ¨ç½² Azure Speech Key Manager..."

# æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
echo "ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
if ! command -v docker &> /dev/null; then
    echo "âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker Compose"
    exit 1
fi

# æ£€æŸ¥ç«¯å£å ç”¨
echo "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨..."
if lsof -i :3000 &> /dev/null; then
    echo "âš ï¸ ç«¯å£3000è¢«å ç”¨ï¼Œè¯·é‡Šæ”¾ç«¯å£æˆ–ä¿®æ”¹é…ç½®"
    lsof -i :3000
fi

if lsof -i :3019 &> /dev/null; then
    echo "âš ï¸ ç«¯å£3019è¢«å ç”¨ï¼Œè¯·é‡Šæ”¾ç«¯å£æˆ–ä¿®æ”¹é…ç½®"
    lsof -i :3019
fi

# é…ç½®Dockeré•œåƒæºï¼ˆå¦‚æœéœ€è¦ï¼‰
echo "ğŸ”§ é…ç½®Dockeré•œåƒæº..."
if [ ! -f /etc/docker/daemon.json ]; then
    sudo mkdir -p /etc/docker
    sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    echo "âœ… Dockeré•œåƒæºé…ç½®å®Œæˆ"
fi

# é¢„ä¸‹è½½é•œåƒï¼ˆé¿å…æ„å»ºæ—¶ç½‘ç»œé—®é¢˜ï¼‰
echo "ğŸ“¥ é¢„ä¸‹è½½Dockeré•œåƒ..."
docker pull node:18-alpine || echo "âš ï¸ node:18-alpineä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨æ„å»ºæ—¶é‡è¯•"
docker pull mysql:5.7 || echo "âš ï¸ mysql:5.7ä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨æ„å»ºæ—¶é‡è¯•"
docker pull redis:7-alpine || echo "âš ï¸ redis:7-alpineä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨æ„å»ºæ—¶é‡è¯•"

# è®¾ç½®æƒé™
echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
chmod +x *.sh

# æ¸…ç†æ—§å®¹å™¨å’Œæ•°æ®
echo "ğŸ§¹ æ¸…ç†æ—§å®¹å™¨å’Œæ•°æ®..."
docker-compose down -v 2>/dev/null || true

# æ„å»ºå’Œå¯åŠ¨
echo "ğŸ—ï¸ æ„å»ºå’Œå¯åŠ¨æœåŠ¡..."
if docker-compose up --build -d; then
    echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
    
    # ç­‰å¾…æœåŠ¡å°±ç»ª
    echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
    sleep 30
    
    # å¥åº·æ£€æŸ¥
    echo "ğŸ” è¿›è¡Œå¥åº·æ£€æŸ¥..."
    if curl -s http://localhost:3019/api/health | grep -q "healthy"; then
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "è®¿é—®åœ°å€ï¼š"
        echo "- å‰ç«¯ç•Œé¢: http://localhost:3000"
        echo "- åç«¯API: http://localhost:3019"
        echo "- å¥åº·æ£€æŸ¥: http://localhost:3019/api/health"
    else
        echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¼š"
        echo "docker-compose logs app"
    fi
else
    echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯"
    exit 1
fi
```

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### ç³»ç»Ÿè¦æ±‚æ£€æŸ¥
- [ ] Dockerç‰ˆæœ¬ >= 20.10
- [ ] Docker Composeç‰ˆæœ¬ >= 2.0
- [ ] å¯ç”¨å†…å­˜ >= 2GB
- [ ] å¯ç”¨ç£ç›˜ç©ºé—´ >= 5GB
- [ ] ç«¯å£3000å’Œ3019æœªè¢«å ç”¨

### ç½‘ç»œè¦æ±‚æ£€æŸ¥
- [ ] èƒ½è®¿é—®Docker Hubæˆ–é…ç½®äº†é•œåƒæº
- [ ] é˜²ç«å¢™å…è®¸Dockerç›¸å…³ç«¯å£
- [ ] å¦‚éœ€AzureåŠŸèƒ½ï¼Œç¡®ä¿èƒ½è®¿é—®Azure API

### æƒé™æ£€æŸ¥
- [ ] å½“å‰ç”¨æˆ·åœ¨dockerç»„ä¸­
- [ ] å¯¹é¡¹ç›®ç›®å½•æœ‰è¯»å†™æƒé™
- [ ] èƒ½æ‰§è¡Œsudoå‘½ä»¤ï¼ˆå¦‚éœ€é…ç½®ç³»ç»Ÿï¼‰

## ğŸ”§ æ•…éšœæ’é™¤å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs app --tail=50

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs --tail=20
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart app

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# å®Œå…¨é‡æ–°éƒ¨ç½²
docker-compose down -v
docker-compose up --build -d
```

### è¿›å…¥å®¹å™¨è°ƒè¯•
```bash
# è¿›å…¥åº”ç”¨å®¹å™¨
docker-compose exec app sh

# æŸ¥çœ‹å®¹å™¨å†…æ–‡ä»¶
docker-compose exec app ls -la /app

# æŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹
docker-compose exec app ps aux
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# ç³»ç»Ÿä¿¡æ¯
uname -a
docker --version
docker-compose --version

# æœåŠ¡çŠ¶æ€
docker-compose ps
docker-compose logs app --tail=50

# ç½‘ç»œæ£€æŸ¥
curl -I http://localhost:3019/api/health
netstat -tlnp | grep -E ':(3000|3019)'

# èµ„æºä½¿ç”¨
free -h
df -h
docker system df
```
