# 客户服务器部署问题解决方案

## 🚨 常见问题及解决方案

### 问题1：网络连接问题 - Docker镜像下载失败

**症状**：
```
failed to solve: node:18-alpine: failed to resolve source metadata for docker.io/library/node:18-alpine: failed to do request: Head "https://mirror.ccs.tencentyun.com/v2/library/node/manifests/18-alpine?ns=docker.io": EOF
```

**原因**：
- 客户服务器网络限制
- Docker镜像源访问问题
- 防火墙阻止Docker Hub访问

**解决方案A：使用国内镜像源**
```bash
# 1. 配置Docker镜像源
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
EOF

# 2. 重启Docker服务
sudo systemctl daemon-reload
sudo systemctl restart docker

# 3. 重新构建
docker-compose up --build -d
```

**解决方案B：预下载镜像**
```bash
# 手动下载所需镜像
docker pull node:18-alpine
docker pull mysql:5.7
docker pull redis:7-alpine

# 然后构建
docker-compose up --build -d
```

**解决方案C：离线部署包**
```bash
# 在有网络的环境中导出镜像
docker save node:18-alpine mysql:5.7 redis:7-alpine > docker-images.tar

# 在客户服务器上导入
docker load < docker-images.tar

# 然后构建
docker-compose up --build -d
```

### 问题2：端口占用问题

**症状**：
```
bind: address already in use
```

**解决方案**：
```bash
# 1. 检查端口占用
lsof -i :3000
lsof -i :3019

# 2. 停止占用进程
sudo kill -9 <PID>

# 3. 或修改端口配置
# 编辑 docker-compose.yml
ports:
  - "0.0.0.0:3001:3000"  # 改为3001
  - "0.0.0.0:3020:3019"  # 改为3020
```

### 问题3：权限问题

**症状**：
```
permission denied
```

**解决方案**：
```bash
# 1. 添加用户到docker组
sudo usermod -aG docker $USER
newgrp docker

# 2. 设置文件权限
sudo chown -R $USER:$USER .
chmod +x *.sh

# 3. 重新登录或重启
```

### 问题4：内存不足

**症状**：
- 容器频繁重启
- 构建过程中断

**解决方案**：
```bash
# 1. 检查内存使用
free -h
docker system df

# 2. 清理Docker缓存
docker system prune -a -f

# 3. 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

## 🛠️ 客户服务器快速部署脚本

### 一键部署脚本
```bash
#!/bin/bash
# 客户服务器一键部署脚本

echo "🚀 开始部署 Azure Speech Key Manager..."

# 检查系统要求
echo "📋 检查系统要求..."
if ! command -v docker &> /dev/null; then
    echo "❌ Docker未安装，请先安装Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "❌ Docker Compose未安装，请先安装Docker Compose"
    exit 1
fi

# 检查端口占用
echo "🔍 检查端口占用..."
if lsof -i :3000 &> /dev/null; then
    echo "⚠️ 端口3000被占用，请释放端口或修改配置"
    lsof -i :3000
fi

if lsof -i :3019 &> /dev/null; then
    echo "⚠️ 端口3019被占用，请释放端口或修改配置"
    lsof -i :3019
fi

# 配置Docker镜像源（如果需要）
echo "🔧 配置Docker镜像源..."
if [ ! -f /etc/docker/daemon.json ]; then
    sudo mkdir -p /etc/docker
    sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    echo "✅ Docker镜像源配置完成"
fi

# 预下载镜像（避免构建时网络问题）
echo "📥 预下载Docker镜像..."
docker pull node:18-alpine || echo "⚠️ node:18-alpine下载失败，将在构建时重试"
docker pull mysql:5.7 || echo "⚠️ mysql:5.7下载失败，将在构建时重试"
docker pull redis:7-alpine || echo "⚠️ redis:7-alpine下载失败，将在构建时重试"

# 设置权限
echo "🔐 设置文件权限..."
chmod +x *.sh

# 清理旧容器和数据
echo "🧹 清理旧容器和数据..."
docker-compose down -v 2>/dev/null || true

# 构建和启动
echo "🏗️ 构建和启动服务..."
if docker-compose up --build -d; then
    echo "✅ 服务启动成功！"
    
    # 等待服务就绪
    echo "⏳ 等待服务就绪..."
    sleep 30
    
    # 健康检查
    echo "🔍 进行健康检查..."
    if curl -s http://localhost:3019/api/health | grep -q "healthy"; then
        echo "✅ 健康检查通过！"
        echo "🎉 部署完成！"
        echo ""
        echo "访问地址："
        echo "- 前端界面: http://localhost:3000"
        echo "- 后端API: http://localhost:3019"
        echo "- 健康检查: http://localhost:3019/api/health"
    else
        echo "❌ 健康检查失败，请查看日志："
        echo "docker-compose logs app"
    fi
else
    echo "❌ 服务启动失败，请查看错误信息"
    exit 1
fi
```

## 📋 部署前检查清单

### 系统要求检查
- [ ] Docker版本 >= 20.10
- [ ] Docker Compose版本 >= 2.0
- [ ] 可用内存 >= 2GB
- [ ] 可用磁盘空间 >= 5GB
- [ ] 端口3000和3019未被占用

### 网络要求检查
- [ ] 能访问Docker Hub或配置了镜像源
- [ ] 防火墙允许Docker相关端口
- [ ] 如需Azure功能，确保能访问Azure API

### 权限检查
- [ ] 当前用户在docker组中
- [ ] 对项目目录有读写权限
- [ ] 能执行sudo命令（如需配置系统）

## 🔧 故障排除命令

### 查看服务状态
```bash
# 查看容器状态
docker-compose ps

# 查看服务日志
docker-compose logs app --tail=50

# 查看所有服务日志
docker-compose logs --tail=20
```

### 重启服务
```bash
# 重启单个服务
docker-compose restart app

# 重启所有服务
docker-compose restart

# 完全重新部署
docker-compose down -v
docker-compose up --build -d
```

### 进入容器调试
```bash
# 进入应用容器
docker-compose exec app sh

# 查看容器内文件
docker-compose exec app ls -la /app

# 查看容器内进程
docker-compose exec app ps aux
```

## 📞 技术支持

如遇到问题，请收集以下信息：

```bash
# 系统信息
uname -a
docker --version
docker-compose --version

# 服务状态
docker-compose ps
docker-compose logs app --tail=50

# 网络检查
curl -I http://localhost:3019/api/health
netstat -tlnp | grep -E ':(3000|3019)'

# 资源使用
free -h
df -h
docker system df
```
